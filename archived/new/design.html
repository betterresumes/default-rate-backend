<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Default Risk Prediction Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <style>
        @media print {
            .page-break { page-break-before: always; }
            body { font-size: 12px; line-height: 1.4; }
            .diagram-container { page-break-inside: avoid; margin: 20px 0; }
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            color: #000;
            background: white;
        }
        
        h1 { 
            border-bottom: 3px solid #000; 
            padding-bottom: 10px;
            font-size: 2.5em;
            margin-bottom: 30px;
        }
        
        h2 { 
            border-left: 4px solid #000; 
            padding-left: 15px;
            margin-top: 40px;
            font-size: 1.8em;
        }
        
        h3 { 
            margin-top: 30px;
            font-size: 1.4em;
        }
        
        h4 { 
            margin-top: 25px;
            font-size: 1.2em;
        }
        
        .summary-box {
            background: white;
            border: 1px solid #000;
            border-radius: 8px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 2px 8px #00000010;
        }
        
        .tech-stack {
            background: #f5f5f5;
            border-left: 4px solid #000;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
        }
        
        .architecture-text {
            background: #fafafa;
            border: 1px solid #ddd;
            padding: 20px;
            margin: 15px 0;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.8;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px #00000010;
        }
        
        th, td {
            border: 1px solid #000;
            padding: 12px;
            text-align: left;
        }
        
        th {
            background: #f0f0f0;
            color: #000;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f0f7ff;
        }
        
        .role-hierarchy {
            background: #fff8e1;
            border: 1px solid #000;
            padding: 20px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .code-block {
            background: #f8f8f8;
            border: 1px solid #000;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            font-size: 0.9em;
        }
        
        .api-endpoint {
            background: #e8f5e8;
            border-left: 4px solid #000;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }
        
        .diagram-container {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #000;
            border-radius: 8px;
            background: #fafafa;
            text-align: center;
        }
        
        .diagram-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .feature-card {
            background: white;
            border: 1px solid #000;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px #00000010;
        }
        
        .feature-card h4 {
            margin-top: 0;
            display: flex;
            align-items: center;
        }
        
        .emoji {
            margin-right: 8px;
            font-size: 1.2em;
        }
        
        ul {
            padding-left: 20px;
        }
        
        li {
            margin: 8px 0;
        }
        
        .highlight {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸ—ï¸ Financial Default Risk Prediction Platform</h1>
    
    <div class="summary-box">
        <h2>ğŸ“‹ Executive Summary</h2>
        
        <p><strong>What We're Building:</strong> A Multi-Tenant Financial Default Risk Prediction Platform that enables organizations to predict corporate default risk using machine learning, manage financial data for multiple companies, and collaborate within organizations with role-based access.</p>
        
        <h3>ğŸ¯ Core Value Proposition</h3>
        <ul>
            <li><span class="highlight">ğŸ¤– ML-Powered Predictions</span> - Annual & quarterly default risk analysis with confidence scores</li>
            <li><span class="highlight">ğŸ¢ Multi-Tenant Organizations</span> - Complete data isolation with shared global datasets</li>
            <li><span class="highlight">ğŸ‘¥ Team Collaboration</span> - Invitation-based system with role management</li>
            <li><span class="highlight">ğŸ“Š Bulk Processing</span> - Excel file uploads with async processing</li>
            <li><span class="highlight">ğŸ”’ Enterprise Security</span> - JWT authentication with organization-scoped access control</li>
        </ul>
        
        <h3>ğŸ’» Technology Stack</h3>
        <div class="tech-stack">
Backend: FastAPI (Python) + PostgreSQL + SQLAlchemy ORM<br>
Caching: Redis (sessions, background jobs)<br>
Background Processing: Celery with Redis broker<br>
Authentication: JWT tokens with custom role-based access<br>
Email: Resend API for transactional emails<br>
ML: Custom models for default prediction
        </div>
    </div>
    
    <h3>Key User Journeys</h3>
    
    <div class="feature-grid">
        <div class="feature-card">
            <h4><span class="emoji">1ï¸âƒ£</span>New User â†’ Organization Setup</h4>
            <p><code>Registration â†’ Email Verification â†’ Create Organization â†’ Become Admin</code></p>
        </div>
        
        <div class="feature-card">
            <h4><span class="emoji">2ï¸âƒ£</span>Team Invitation Process</h4>
            <p><code>Admin Sends Invite â†’ Email Notification â†’ User Accepts â†’ Joins Organization</code></p>
        </div>
        
        <div class="feature-card">
            <h4><span class="emoji">3ï¸âƒ£</span>Financial Prediction Creation</h4>
            <p><code>Select Company â†’ Input Financial Ratios â†’ ML Processing â†’ Risk Analysis</code></p>
        </div>
        
        <div class="feature-card">
            <h4><span class="emoji">4ï¸âƒ£</span>Bulk Data Processing</h4>
            <p><code>Upload Excel â†’ Async Processing â†’ Progress Tracking â†’ Results Download</code></p>
        </div>
    </div>

    <div class="page-break"></div>
    
    <h2>ğŸ“Š API Endpoints Overview</h2>
    
    <h3>ğŸ”’ Authentication APIs</h3>
    <div class="api-endpoint">
POST /api/register-simple     # User registration<br>
POST /api/login              # User authentication<br>
GET  /api/me                 # Current user profile
    </div>
    
    <h3>ğŸ¢ Organization Management</h3>
    <div class="api-endpoint">
POST /api/v1/organizations/                    # Create organization<br>
GET  /api/v1/organizations/me                  # Get my organization<br>
GET  /api/v1/organizations/{id}/members        # List team members<br>
POST /api/v1/organizations/{id}/invitations/   # Send invitation<br>
GET  /api/v1/organizations/{id}/invitations/   # List invitations
    </div>
    
    <h3>ğŸ“§ Invitation System</h3>
    <div class="api-endpoint">
POST /api/invitations/{token}/accept           # Accept invitation<br>
GET  /api/invitations/{token}                  # Get invitation details
    </div>
    
    <h3>ğŸ¢ Company Management</h3>
    <div class="api-endpoint">
GET  /api/v1/companies/                        # List accessible companies<br>
POST /api/v1/companies/                        # Create new company<br>
GET  /api/v1/companies/{id}                    # Get company details
    </div>
    
    <h3>ğŸ“ˆ Prediction APIs</h3>
    <div class="api-endpoint">
POST /api/v1/predictions/predict-annual        # Create annual prediction<br>
POST /api/v1/predictions/predict-quarterly     # Create quarterly prediction<br>
POST /api/v1/predictions/bulk-predict-async    # Bulk processing<br>
GET  /api/v1/predictions/job-status/{job_id}   # Check processing status<br>
GET  /api/v1/predictions/summary               # Analytics dashboard
    </div>

    <div class="page-break"></div>
    
    <h2>ğŸš€ Key Features & Benefits</h2>
    
    <div class="feature-grid">
        <div class="feature-card">
            <h4><span class="emoji">ğŸ¤–</span>Advanced ML Capabilities</h4>
            <ul>
                <li><strong>Dual Model System</strong>: Annual and Quarterly prediction models</li>
                <li><strong>Ensemble Predictions</strong>: Multiple algorithms for higher accuracy</li>
                <li><strong>Risk Categorization</strong>: Automatic risk level assignment (Very Low â†’ Very High)</li>
                <li><strong>Confidence Scoring</strong>: Model certainty indicators</li>
                <li><strong>Feature Importance</strong>: Understanding key risk factors</li>
            </ul>
        </div>
        
        <div class="feature-card">
            <h4><span class="emoji">ğŸ¢</span>Enterprise Multi-Tenancy</h4>
            <ul>
                <li><strong>Complete Data Isolation</strong>: Organization-scoped data access</li>
                <li><strong>Global Data Sharing</strong>: Public companies visible across organizations</li>
                <li><strong>Flexible Team Management</strong>: Admin and user roles with granular permissions</li>
                <li><strong>Scalable Architecture</strong>: Support for unlimited organizations and users</li>
            </ul>
        </div>
        
        <div class="feature-card">
            <h4><span class="emoji">ğŸ“Š</span>Bulk Processing & Analytics</h4>
            <ul>
                <li><strong>Excel Import</strong>: Async processing of large financial datasets</li>
                <li><strong>Progress Tracking</strong>: Real-time job status and completion estimates</li>
                <li><strong>Batch Predictions</strong>: Process hundreds of companies simultaneously</li>
                <li><strong>Analytics Dashboard</strong>: Risk distribution, trends, and insights</li>
            </ul>
        </div>
        
        <div class="feature-card">
            <h4><span class="emoji">ğŸ”’</span>Security & Compliance</h4>
            <ul>
                <li><strong>JWT Authentication</strong>: Secure token-based authentication</li>
                <li><strong>Role-Based Access Control</strong>: Granular permission management</li>
                <li><strong>Data Validation</strong>: Comprehensive input validation and sanitization</li>
                <li><strong>Audit Trails</strong>: Complete activity logging and tracking</li>
            </ul>
        </div>
    </div>

    <div class="page-break"></div>
    
    <h2>ğŸ—ï¸ System Architecture Overview</h2>
    
    <h3>High-Level Architecture</h3>
    <div class="architecture-text">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client Layer   â”‚    â”‚   API Gateway    â”‚    â”‚ Business Logic  â”‚
â”‚                 â”‚    â”‚                  â”‚    â”‚                 â”‚
â”‚ â€¢ Web Frontend  â”‚â”€â”€â”€â–¶â”‚ â€¢ FastAPI Server â”‚â”€â”€â”€â–¶â”‚ â€¢ Organization  â”‚
â”‚ â€¢ Mobile App    â”‚    â”‚ â€¢ Authentication â”‚    â”‚ â€¢ Prediction    â”‚
â”‚ â€¢ API Clients   â”‚    â”‚ â€¢ CORS Middlewareâ”‚    â”‚ â€¢ ML Service    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚                        â”‚
                                â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Data Layer    â”‚    â”‚Background Processâ”‚    â”‚  External APIs  â”‚
â”‚                 â”‚    â”‚                  â”‚    â”‚                 â”‚
â”‚ â€¢ PostgreSQL    â”‚    â”‚ â€¢ Celery Workers â”‚    â”‚ â€¢ Resend Email  â”‚
â”‚ â€¢ Redis Cache   â”‚    â”‚ â€¢ Task Queue     â”‚    â”‚ â€¢ ML Models     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    </div>
    
    <h3>Component Responsibilities</h3>
    <ul>
        <li><strong>FastAPI Server</strong>: RESTful APIs, request validation, authentication middleware</li>
        <li><strong>Organization Service</strong>: Multi-tenant data management, team collaboration</li>
        <li><strong>Prediction Service</strong>: Financial data processing, ML model integration</li>
        <li><strong>Background Processing</strong>: Bulk data uploads, email notifications</li>
        <li><strong>PostgreSQL</strong>: Primary data storage with proper indexing</li>
        <li><strong>Redis</strong>: Session management, job queues, caching layer</li>
    </ul>

    <div class="page-break"></div>
    
    <h2>ğŸ” User Roles & Permissions Matrix</h2>
    
    <div class="role-hierarchy">
        <h3>Role Hierarchy</h3>
        <div class="code-block">
Super Admin (Global)
â”œâ”€â”€ Full system access
â”œâ”€â”€ Can manage any organization
â””â”€â”€ Global company data management

Organization Admin
â”œâ”€â”€ Full organization access
â”œâ”€â”€ Team member management
â”œâ”€â”€ Organization data control
â””â”€â”€ Invitation management

Organization User  
â”œâ”€â”€ Organization data access
â”œâ”€â”€ Can create predictions
â”œâ”€â”€ Limited admin functions
â””â”€â”€ Collaborative access

No Organization User
â”œâ”€â”€ Global data view only
â”œâ”€â”€ Can create own organization
â”œâ”€â”€ Limited functionality
â””â”€â”€ Personal workspace
        </div>
    </div>
    
    <h3>Detailed Permission Matrix</h3>
    <table>
        <thead>
            <tr>
                <th><strong>Action</strong></th>
                <th><strong>Super Admin</strong></th>
                <th><strong>Org Admin</strong></th>
                <th><strong>Org User</strong></th>
                <th><strong>No Org User</strong></th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="5" style="background:#f0f0f0; font-weight:bold;">ğŸ¢ Organizations</td></tr>
            <tr>
                <td>Create Organization</td>
                <td>âœ… All</td>
                <td>âœ… Own</td>
                <td>âœ… New</td>
                <td>âœ… First</td>
            </tr>
            <tr>
                <td>View All Organizations</td>
                <td>âœ…</td>
                <td>âŒ</td>
                <td>âŒ</td>
                <td>âŒ</td>
            </tr>
            <tr>
                <td>Delete Organization</td>
                <td>âœ… Any</td>
                <td>âœ… Own</td>
                <td>âŒ</td>
                <td>âŒ</td>
            </tr>
            <tr><td colspan="5" style="background:#f0f0f0; font-weight:bold;">ğŸ‘¥ Team Management</td></tr>
            <tr>
                <td>Send Invitations</td>
                <td>âœ…</td>
                <td>âœ…</td>
                <td>âŒ</td>
                <td>âŒ</td>
            </tr>
            <tr>
                <td>Remove Members</td>
                <td>âœ…</td>
                <td>âœ…</td>
                <td>âŒ</td>
                <td>âŒ</td>
            </tr>
            <tr>
                <td>Manage Roles</td>
                <td>âœ…</td>
                <td>âœ…</td>
                <td>âŒ</td>
                <td>âŒ</td>
            </tr>
            <tr><td colspan="5" style="background:#f0f0f0; font-weight:bold;">ğŸ¢ Companies</td></tr>
            <tr>
                <td>View Global Companies</td>
                <td>âœ…</td>
                <td>âœ…</td>
                <td>âœ…</td>
                <td>âœ…</td>
            </tr>
            <tr>
                <td>View Org Companies</td>
                <td>âœ…</td>
                <td>âœ…</td>
                <td>âœ…</td>
                <td>âŒ</td>
            </tr>
            <tr>
                <td>Create Global Companies</td>
                <td>âœ…</td>
                <td>âŒ</td>
                <td>âŒ</td>
                <td>âŒ</td>
            </tr>
            <tr>
                <td>Create Org Companies</td>
                <td>âœ…</td>
                <td>âœ…</td>
                <td>âœ…</td>
                <td>âŒ</td>
            </tr>
            <tr><td colspan="5" style="background:#f0f0f0; font-weight:bold;">ğŸ“ˆ Predictions</td></tr>
            <tr>
                <td>View Global Predictions</td>
                <td>âœ…</td>
                <td>âœ…</td>
                <td>âœ…</td>
                <td>âœ…</td>
            </tr>
            <tr>
                <td>View Org Predictions</td>
                <td>âœ…</td>
                <td>âœ…</td>
                <td>âœ…</td>
                <td>âŒ</td>
            </tr>
            <tr>
                <td>Create Predictions</td>
                <td>âœ…</td>
                <td>âœ…</td>
                <td>âœ…</td>
                <td>âŒ</td>
            </tr>
            <tr>
                <td>Bulk Processing</td>
                <td>âœ…</td>
                <td>âœ…</td>
                <td>âœ…</td>
                <td>âŒ</td>
            </tr>
        </tbody>
    </table>

    <div class="page-break"></div>
    
    <h2>ğŸ—ƒï¸ Database Schema & Data Model</h2>
    
    <h3>Core Entity Relationships</h3>
    <div class="code-block">
Organizations (1) â”€â”€â”€â”€ (N) Users
     â”‚                     â”‚
     â”‚                     â”‚
     â”œâ”€â”€ (1) â”€â”€â”€â”€ (N) Invitations
     â”‚                     â”‚
     â””â”€â”€ (1) â”€â”€â”€â”€ (N) Companies â”€â”€â”€â”€ (N) Predictions
                             â”‚
                             â””â”€â”€ Annual & Quarterly Types
    </div>
    
    <h3>Key Tables Structure</h3>
    
    <h4>ğŸ¢ organizations</h4>
    <div class="code-block">
id: UUID (PK)
name: VARCHAR(255) -- "HDFC Bank", "ICICI Bank" 
slug: VARCHAR(100) UNIQUE -- "hdfc-bank"
domain: VARCHAR(255) -- "hdfc.com"
is_active: BOOLEAN DEFAULT true
max_users: INTEGER DEFAULT 100
created_by: UUID â†’ users.id
created_at, updated_at: TIMESTAMP
    </div>
    
    <h4>ğŸ‘¤ users</h4>
    <div class="code-block">
id: UUID (PK)
email: VARCHAR(255) UNIQUE INDEXED
username: VARCHAR(100) UNIQUE INDEXED  
organization_id: UUID â†’ organizations.id INDEXED
organization_role: ENUM('admin', 'user')
global_role: ENUM('super_admin', 'user')
is_active: BOOLEAN DEFAULT true
created_at, updated_at: TIMESTAMP
    </div>
    
    <h4>ğŸ¢ companies</h4>
    <div class="code-block">
id: UUID (PK)
symbol: VARCHAR(20) UNIQUE INDEXED -- "RELIANCE", "TCS"
name: VARCHAR(255) -- "Reliance Industries"
market_cap: DECIMAL(20,2)
sector: VARCHAR(100) -- "Energy", "Technology"
organization_id: UUID â†’ organizations.id INDEXED
is_global: BOOLEAN DEFAULT false INDEXED
    </div>
    
    <h4>ğŸ“ˆ predictions (Annual & Quarterly)</h4>
    <div class="code-block">
-- Common fields
id: UUID (PK)
company_id: UUID â†’ companies.id
organization_id: UUID â†’ organizations.id INDEXED
reporting_year: VARCHAR(4) -- "2024"
reporting_quarter: VARCHAR(2) -- "Q1", "Q2", "Q3", "Q4"

-- ML Results
probability: DECIMAL(5,4) -- 0.0 to 1.0
risk_level: VARCHAR(20) -- "Low", "Medium", "High"
confidence: DECIMAL(5,4)
predicted_at: TIMESTAMP
created_by: UUID â†’ users.id
    </div>
    
    <h3>Data Access Rules</h3>
    <ul>
        <li><strong>Global Companies</strong> (<code>is_global=true</code>): Visible to all organizations</li>
        <li><strong>Organization Companies</strong> (<code>organization_id=specific</code>): Only visible to that organization</li>
        <li><strong>Personal Companies</strong> (<code>organization_id=null</code>): Creator only access</li>
        <li><strong>Predictions</strong>: Follow parent company access rules</li>
    </ul>

    <div class="page-break"></div>
    
    <h2>ğŸ”„ Complete User Flow Workflows</h2>
    
    <div class="diagram-container">
        <div class="diagram-title">Complete User Flow & Application Architecture</div>
        <div class="mermaid">
graph TD
    %% User Registration & Organization Setup Flow
    START([ğŸ‘¤ New User]) --> REG[ğŸ“ Register Account]
    REG --> VERIFY{ğŸ“§ Email Verified?}
    VERIFY -->|Yes| LOGIN[ğŸ”‘ Login Success]
    VERIFY -->|No| EMAIL_VERIFY[ğŸ“§ Verify Email]
    EMAIL_VERIFY --> LOGIN
    
    LOGIN --> ORG_CHECK{ğŸ¢ Has Organization?}
    
    %% No Organization Path
    ORG_CHECK -->|No| CREATE_ORG[ğŸ—ï¸ Create Organization]
    CREATE_ORG --> ORG_ADMIN[ğŸ‘‘ Become Org Admin]
    
    %% Has Organization Path  
    ORG_CHECK -->|Yes| ORG_USER[ğŸ‘¥ Access Organization]
    ORG_ADMIN --> INVITE_TEAM[ğŸ“§ Invite Team Members]
    
    %% Team Invitation Flow
    INVITE_TEAM --> SEND_INVITE[ğŸ“¤ Send Invitation Email]
    SEND_INVITE --> NEW_MEMBER[ğŸ‘¤ New Member]
    NEW_MEMBER --> ACCEPT_INVITE{âœ… Accept Invitation?}
    ACCEPT_INVITE -->|Yes| JOIN_ORG[ğŸ¤ Join Organization]
    ACCEPT_INVITE -->|No| EXPIRE[â° Invitation Expires]
    JOIN_ORG --> ORG_USER
    
    %% Main Application Features
    ORG_USER --> DASHBOARD[ğŸ“Š Organization Dashboard]
    ORG_ADMIN --> DASHBOARD
    
    DASHBOARD --> COMPANIES[ğŸ¢ Manage Companies]
    DASHBOARD --> PREDICTIONS[ğŸ“ˆ Financial Predictions]
    DASHBOARD --> TEAM_MGMT[ğŸ‘¥ Team Management]
    
    %% Company Management
    COMPANIES --> VIEW_GLOBAL[ğŸŒ View Global Companies]
    COMPANIES --> CREATE_COMPANY[â• Create Company]
    COMPANIES --> ORG_COMPANIES[ğŸ¢ Organization Companies]
    
    %% Prediction Workflows
    PREDICTIONS --> ANNUAL_PRED[ğŸ“… Annual Prediction]
    PREDICTIONS --> QUARTERLY_PRED[ğŸ“Š Quarterly Prediction] 
    PREDICTIONS --> BULK_PROCESS[ğŸ“‹ Bulk Processing]
    
    %% Annual Prediction Flow
    ANNUAL_PRED --> SELECT_COMPANY[ğŸ¯ Select Company]
    SELECT_COMPANY --> INPUT_RATIOS[ğŸ“Š Input Financial Ratios]
    INPUT_RATIOS --> ML_ANNUAL[ğŸ¤– ML Processing - Annual Model]
    ML_ANNUAL --> ANNUAL_RESULT[ğŸ“ˆ Risk Analysis Result]
    
    %% Quarterly Prediction Flow  
    QUARTERLY_PRED --> SELECT_COMPANY2[ğŸ¯ Select Company]
    SELECT_COMPANY2 --> INPUT_RATIOS2[ğŸ“Š Input Financial Ratios]
    INPUT_RATIOS2 --> ML_QUARTERLY[ğŸ¤– ML Processing - Quarterly Model]
    ML_QUARTERLY --> QUARTERLY_RESULT[ğŸ“Š Ensemble Prediction Result]
    
    %% Bulk Processing Flow
    BULK_PROCESS --> UPLOAD_EXCEL[ğŸ“¤ Upload Excel File]
    UPLOAD_EXCEL --> VALIDATE_FILE{âœ… File Valid?}
    VALIDATE_FILE -->|No| FILE_ERROR[âŒ Validation Error]
    VALIDATE_FILE -->|Yes| QUEUE_JOB[â³ Queue Background Job]
    QUEUE_JOB --> CELERY_PROCESS[âš™ï¸ Celery Worker Processing]
    CELERY_PROCESS --> PROGRESS_UPDATE[ğŸ“Š Progress Updates]
    PROGRESS_UPDATE --> JOB_COMPLETE[âœ… Job Complete]
    JOB_COMPLETE --> DOWNLOAD_RESULTS[â¬‡ï¸ Download Results]
    
    %% Team Management (Admin Only)
    TEAM_MGMT --> VIEW_MEMBERS[ğŸ‘¥ View Team Members]
    TEAM_MGMT --> MANAGE_ROLES[ğŸ‘‘ Manage Roles]
    TEAM_MGMT --> REMOVE_MEMBERS[âŒ Remove Members]
    
    %% Data Access Rules
    VIEW_GLOBAL --> GLOBAL_DATA[(ğŸŒ Global Companies<br/>Visible to All)]
    ORG_COMPANIES --> ORG_DATA[(ğŸ¢ Organization Data<br/>Org Members Only)]
    ANNUAL_RESULT --> SAVE_PREDICTION[(ğŸ’¾ Save to Database<br/>Organization Scoped)]
    QUARTERLY_RESULT --> SAVE_PREDICTION
    
    %% Styling
    classDef startEnd fill:#e1f5fe,stroke:#01579b,stroke-width:3px
    classDef process fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef decision fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef mlProcess fill:#e8f5e8,stroke:#1b5e20,stroke-width:3px
    classDef dataStore fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    
    class START,NEW_MEMBER startEnd
    class REG,LOGIN,CREATE_ORG,INVITE_TEAM,DASHBOARD,COMPANIES,PREDICTIONS process
    class VERIFY,ORG_CHECK,ACCEPT_INVITE,VALIDATE_FILE decision
    class ML_ANNUAL,ML_QUARTERLY,CELERY_PROCESS mlProcess
    class GLOBAL_DATA,ORG_DATA,SAVE_PREDICTION dataStore
        </div>
    </div>

    <div class="page-break"></div>

    <div class="diagram-container">
        <div class="diagram-title">System Architecture & Multi-Tenant User Roles</div>
        <div class="mermaid">
graph TB
    %% User Types & Roles
    subgraph USERS["ğŸ‘¥ User Types & Access Levels"]
        SUPER_ADMIN[ğŸ‘‘ Super Admin<br/>ğŸ”“ Global System Access<br/>ğŸ¢ All Organizations<br/>ğŸŒ Global Data Management]
        
        subgraph ORG_A["ğŸ¢ Organization A - HDFC Bank"]
            ADMIN_A[ğŸ‘‘ Org Admin<br/>ğŸ“§ Send Invitations<br/>ğŸ‘¥ Manage Team<br/>ğŸ¢ Full Org Access]
            USER_A[ğŸ‘¤ Org User<br/>ğŸ“Š Create Predictions<br/>ğŸ¢ View Org Data<br/>ğŸ¤ Collaborate]
        end
        
        subgraph ORG_B["ğŸ¢ Organization B - ICICI Bank"]  
            ADMIN_B[ğŸ‘‘ Org Admin<br/>ğŸ“§ Send Invitations<br/>ğŸ‘¥ Manage Team<br/>ğŸ¢ Full Org Access]
            USER_B[ğŸ‘¤ Org User<br/>ğŸ“Š Create Predictions<br/>ğŸ¢ View Org Data<br/>ğŸ¤ Collaborate]
        end
        
        NO_ORG_USER[ğŸ‘¤ Independent User<br/>ğŸŒ Global Data Only<br/>ğŸ—ï¸ Can Create Org<br/>ğŸ”’ Limited Access]
    end
    
    %% Application Layer
    subgraph APP_LAYER["ğŸ–¥ï¸ Application Layer"]
        subgraph CLIENT["ğŸ“± Client Applications"]
            WEB[ğŸŒ Web Frontend]
            MOBILE[ğŸ“± Mobile App]  
            API_CLIENT[ğŸ”Œ API Clients]
        end
        
        subgraph API_GATEWAY["ğŸšª API Gateway & Middleware"]
            FASTAPI[âš¡ FastAPI Server<br/>ğŸ“ Request Validation<br/>ğŸ”’ JWT Authentication]
            AUTH_MIDDLEWARE[ğŸ›¡ï¸ Auth Middleware<br/>ğŸ‘¤ User Context<br/>ğŸ¢ Organization Scope]
            CORS[ğŸ”— CORS Protection<br/>ğŸŒ Cross-Origin Control]
        end
    end
    
    %% Business Logic Layer
    subgraph BUSINESS_LOGIC["ğŸ§  Business Logic Layer"]
        ORG_SERVICE[ğŸ¢ Organization Service<br/>ğŸ‘¥ Team Management<br/>ğŸ“§ Invitations<br/>ğŸ”’ Multi-Tenant Logic]
        
        PREDICTION_SERVICE[ğŸ“Š Prediction Service<br/>ğŸ¤– ML Integration<br/>ğŸ“ˆ Risk Analysis<br/>ğŸ’¾ Data Processing]
        
        ML_SERVICE[ğŸ¤– ML Service<br/>ğŸ“… Annual Models<br/>ğŸ“Š Quarterly Models<br/>ğŸ¯ Ensemble Predictions]
        
        EMAIL_SERVICE[ğŸ“§ Email Service<br/>ğŸ“¤ Transactional Emails<br/>ğŸ”— Invitation Links<br/>ğŸ“¨ Notifications]
    end
    
    %% Data Layer  
    subgraph DATA_LAYER["ğŸ’¾ Data Layer & Storage"]
        subgraph POSTGRESQL["ğŸ˜ PostgreSQL Database"]
            subgraph GLOBAL_DATA["ğŸŒ Global Data (Shared)"]
                GLOBAL_COMPANIES[(ğŸ¢ Global Companies<br/>ğŸ“Š Market Data<br/>ğŸ‘ï¸ Visible to All)]
            end
            
            subgraph ORG_A_DATA["ğŸ¢ Organization A Data"]
                ORG_A_COMPANIES[(ğŸ¢ Org A Companies<br/>ğŸ“ˆ Org A Predictions<br/>ğŸ‘¥ Team Members)]
            end
            
            subgraph ORG_B_DATA["ğŸ¢ Organization B Data"]  
                ORG_B_COMPANIES[(ğŸ¢ Org B Companies<br/>ğŸ“ˆ Org B Predictions<br/>ğŸ‘¥ Team Members)]
            end
            
            USERS_TABLE[(ğŸ‘¤ Users Table<br/>ğŸ” Authentication<br/>ğŸ¢ Organization Links)]
            INVITATIONS_TABLE[(ğŸ“§ Invitations<br/>ğŸ”— Tokens<br/>â° Expiration)]
        end
        
        REDIS[(ğŸ”´ Redis Cache<br/>ğŸ« Session Management<br/>âš™ï¸ Background Jobs<br/>ğŸ“Š Progress Tracking)]
    end
    
    %% Background Processing
    subgraph BACKGROUND["âš™ï¸ Background Processing"]
        CELERY_WORKERS[ğŸ‘· Celery Workers<br/>ğŸ“Š Bulk Processing<br/>ğŸ“§ Email Queue<br/>ğŸ“ˆ ML Predictions]
        TASK_QUEUE[ğŸ“‹ Task Queue<br/>â³ Job Management<br/>ğŸ“Š Progress Updates]
    end
    
    %% External Services
    subgraph EXTERNAL["ğŸŒ External Services"]
        RESEND_API[ğŸ“§ Resend API<br/>ğŸ“¤ Email Delivery<br/>ğŸ“¨ Templates]
        ML_MODELS[ğŸ¤– ML Models<br/>ğŸ“… Annual Prediction<br/>ğŸ“Š Quarterly Prediction]
    end
    
    %% User Access Connections
    SUPER_ADMIN -.->|Full Access| GLOBAL_DATA
    SUPER_ADMIN -.->|Admin Access| ORG_A_DATA  
    SUPER_ADMIN -.->|Admin Access| ORG_B_DATA
    
    ADMIN_A -.->|Read Access| GLOBAL_DATA
    ADMIN_A -.->|Full Access| ORG_A_DATA
    USER_A -.->|Read Access| GLOBAL_DATA  
    USER_A -.->|User Access| ORG_A_DATA
    
    ADMIN_B -.->|Read Access| GLOBAL_DATA
    ADMIN_B -.->|Full Access| ORG_B_DATA
    USER_B -.->|Read Access| GLOBAL_DATA
    USER_B -.->|User Access| ORG_B_DATA
    
    NO_ORG_USER -.->|Read Only| GLOBAL_DATA
    
    %% Application Flow Connections
    CLIENT --> FASTAPI
    FASTAPI --> AUTH_MIDDLEWARE
    AUTH_MIDDLEWARE --> ORG_SERVICE
    AUTH_MIDDLEWARE --> PREDICTION_SERVICE
    
    ORG_SERVICE --> USERS_TABLE
    ORG_SERVICE --> INVITATIONS_TABLE
    ORG_SERVICE --> EMAIL_SERVICE
    
    PREDICTION_SERVICE --> ML_SERVICE
    PREDICTION_SERVICE --> ORG_A_DATA
    PREDICTION_SERVICE --> ORG_B_DATA
    PREDICTION_SERVICE --> GLOBAL_DATA
    
    ML_SERVICE --> ML_MODELS
    EMAIL_SERVICE --> RESEND_API
    
    %% Background Processing Connections
    PREDICTION_SERVICE --> CELERY_WORKERS
    ORG_SERVICE --> CELERY_WORKERS  
    CELERY_WORKERS --> TASK_QUEUE
    TASK_QUEUE --> REDIS
    AUTH_MIDDLEWARE --> REDIS
    
    %% Styling
    classDef userRole fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef systemLayer fill:#f1f8e9,stroke:#33691e,stroke-width:2px  
    classDef dataStore fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef external fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef globalData fill:#e8f5e8,stroke:#2e7d32,stroke-width:3px
    classDef orgData fill:#fff8e1,stroke:#f9a825,stroke-width:2px
    
    class SUPER_ADMIN,ADMIN_A,ADMIN_B,USER_A,USER_B,NO_ORG_USER userRole
    class FASTAPI,ORG_SERVICE,PREDICTION_SERVICE,ML_SERVICE,EMAIL_SERVICE systemLayer
    class POSTGRESQL,REDIS,USERS_TABLE,INVITATIONS_TABLE,CELERY_WORKERS dataStore  
    class RESEND_API,ML_MODELS external
    class GLOBAL_COMPANIES,GLOBAL_DATA globalData
    class ORG_A_COMPANIES,ORG_B_COMPANIES,ORG_A_DATA,ORG_B_DATA orgData
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#000000',
                primaryTextColor: '#ffffff',
                primaryBorderColor: '#000000',
                lineColor: '#000000',
                sectionBkgColor: '#f5f5f5',
                altSectionBkgColor: '#ffffff',
                gridColor: '#000000',
                secondaryColor: '#f5f5f5',
                tertiaryColor: '#f5f5f5'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            securityLevel: 'loose'
        });
        
        // Function to trigger print
        function printPDF() {
            window.print();
        }
        
        // Add print button for user convenience
        document.addEventListener('DOMContentLoaded', function() {
            const printBtn = document.createElement('button');
            printBtn.innerHTML = 'ğŸ–¨ï¸ Print PDF';
            printBtn.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #000000;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                font-weight: bold;
                box-shadow: 0 2px 8px #00000030;
                z-index: 1000;
            `;
            printBtn.onclick = printPDF;
            document.body.appendChild(printBtn);
        });
    </script>
    
</body>
</html>